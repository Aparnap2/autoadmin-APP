appId: host.exp.Exponent
name: "HTTP Reconnection & Error Handling Flow"
tags:
  - critical
  - error-handling
  - http-only
  - reconnection
env:
  HTTP_ONLY_MODE: "true"
  RECOVERY_TIMEOUT: "30000"
  MAX_RETRY_ATTEMPTS: "3"
---
# Navigate to dashboard
- launchApp
- tapOn:
    text: "Dashboard"

# Wait for dashboard initialization
- extendedWaitUntil:
    visible: "AutoAdmin Dashboard"
    timeout: 15000

# Test connection status monitoring
- assertVisible:
    id: "backend-status"
- assertVisible: "Backend is online"

# Test network interruption simulation
- evalScript: ${console.log('üîå Simulating network interruption...')}
- waitBetween: 2000

# Wait for connection loss detection
- extendedWaitUntil:
    visible: "Connection lost"
    timeout: 10000
- assertVisible: "Attempting to reconnect..."

# Test automatic reconnection via HTTP
- extendedWaitUntil:
    visible: "Reconnecting..."
    timeout: 5000
- extendedWaitUntil:
    visible: "Connection restored"
    timeout: 15000

# Verify dashboard functionality after reconnection
- assertVisible: "System Status"
- assertVisible: "Agent Swarm Status"
- tapOn: "Quick Actions"
- tapOn: "Status Update"

# Verify post-reconnection functionality
- extendedWaitUntil:
    visible: "Status update completed"
    timeout: 10000

# Test multiple rapid reconnections
- repeat:
    times: 3
    commands:
      - evalScript: ${console.log('üîÑ Simulating rapid reconnection...')}
      - waitBetween: 1000
      - extendedWaitUntil:
          visible: "Connection restored"
          timeout: 8000

# Test server error handling
- evalScript: ${console.log('üö´ Simulating server error...')}
- waitBetween: 2000

# Wait for error detection
- extendedWaitUntil:
    visible: "Server error occurred"
    timeout: 8000

# Test error recovery
- extendedWaitUntil:
    visible: "Attempting recovery..."
    timeout: 5000
- extendedWaitUntil:
    visible: "Error recovered"
    timeout: 12000

# Verify error state handling
- assertVisible: "Some features may be limited"
- assertNotVisible: "App crashed"

# Test streaming interruption recovery
- tapOn:
    text: "Chat"
- assertVisible:
    id: "agent-chat-interface"

# Test streaming interruption
- evalScript: ${console.log('üì° Testing streaming interruption...')}
- tapOn:
    id: "chat-input"
- inputText: "Test streaming recovery"
- tapOn: "Send"

# Wait for streaming to start
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 5000

# Simulate streaming interruption
- evalScript: ${console.log('‚ö†Ô∏è Simulating streaming interruption...')}
- waitBetween: 2000

# Test streaming recovery
- extendedWaitUntil:
    visible: "Streaming recovered"
    timeout: 8000
- extendedWaitUntil:
    visible: "CEO Agent"
    timeout: 10000

# Verify streaming completes
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 5000

# Test timeout handling
- evalScript: ${console.log('‚è±Ô∏è Testing timeout handling...')}
- waitBetween: 1000

# Test long operation timeout
- tapOn:
    id: "chat-input"
- inputText: "This should test timeout handling"
- tapOn: "Send"

# Wait for timeout handling
- extendedWaitUntil:
    visible: "Operation timed out"
    timeout: 20000

# Verify timeout recovery
- extendedWaitUntil:
    visible: "Timeout handled gracefully"
    timeout: 5000
- assertVisible: "Retry option available"

# Test retry mechanism
- tapOn: "Retry"
- extendedWaitUntil:
    visible: "Retrying..."
    timeout: 5000

# Test failed request handling
- evalScript: ${console.log('‚ùå Testing failed request handling...')}
- waitBetween: 1000

# Test multiple failed requests
- repeat:
    times: 3
    commands:
      - tapOn:
          id: "chat-input"
      - inputText: "Test failed request ${__INDEX__}"
      - tapOn: "Send"
      - waitBetween: 1000

# Verify failed request handling
- assertVisible: "Request failed"
- assertVisible: "Error handled gracefully"
- assertNotVisible: "App crashed"

# Test fallback mechanisms
- extendedWaitUntil:
    visible: "Using fallback mechanism"
    timeout: 8000
- assertVisible: "SSE fallback active"

# Test partial failure handling
- evalScript: ${console.log('‚ö†Ô∏è Testing partial failure handling...')}
- waitBetween: 1000

# Navigate back to dashboard
- tapOn:
    text: "Dashboard"

# Test partial data loading
- extendedWaitUntil:
    visible: "Partial data loaded"
    timeout: 10000
- assertVisible: "Some features limited"

# Verify core functionality remains
- assertVisible: "System Status"
- assertVisible: "Agent Swarm Status"

# Test complete recovery
- extendedWaitUntil:
    visible: "Full recovery completed"
    timeout: 15000
- assertVisible: "All features restored"

# Test error logging and monitoring
- evalScript: ${console.log('üìù Testing error logging...')}
- waitBetween: 1000

# Verify error indicators
- assertVisible: "Error logged successfully"
- assertNotVisible: "Critical error"

# Test graceful degradation
- assertVisible: "Limited functionality available"
- assertNotVisible: "System unavailable"

# Log successful error handling test
- evalScript: ${console.log('‚úÖ Error handling and reconnection test completed successfully')}

# Take screenshot of recovered state
- takeScreenshot: "error-recovery-http-only-complete"