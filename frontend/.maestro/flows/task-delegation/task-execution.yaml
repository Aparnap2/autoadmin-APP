# Test: Task Execution and Monitoring
appId: com.autoadmin.app

---
# Setup
- runFlow:
    file: ../utils/helpers.yaml
    args:
      message: "Starting Task Execution Test"

- tapOn:
    text: "Explore"
    label: "Navigate to Task Manager tab"

- waitFor:
    testID: "task-manager-screen"
    timeout: 10000

---
# Test 1: Select and Start a Task
- scrollUntilVisible:
    element:
      text: "Q4 Marketing Campaign"
    direction: DOWN
    timeout: 5000

- tapOn:
    text: "Q4 Marketing Campaign"
    label: "Open marketing task"

- tapOn:
    text: "Start Task"
    label: "Start task execution"

# Wait for task to start
- waitFor:
    text: "Running"
    timeout: 15000

# Verify status changed
- assertVisible:
    text: "In Progress"
    regex: true

---
# Test 2: Monitor Task Progress
- scrollUntilVisible:
    element:
      text: "Progress"
    direction: DOWN
    timeout: 5000

# Assert progress indicator
- assertVisible:
    id: "progress-bar"

# Wait for progress updates
- waitFor:
    text: "25%"
    regex: true
    timeout: 30000

- assertVisible:
    text: "Analyzing campaigns"
    regex: true

---
# Test 3: Check Real-time Updates
# Wait for additional progress
- waitFor:
    text: "50%"
    regex: true
    timeout: 30000

- assertVisible:
    text: "Calculating ROI"
    regex: true

# Check that status is updating
- extendedWaitUntil:
    visible:
      text: "75%"
      regex: true
    timeout: 30000

---
# Test 4: Wait for Task Completion
- waitFor:
    text: "Completed"
    timeout: 60000

# Assert completion status
- assertVisible:
    text: "Task completed successfully"

---
# Test 5: Review Task Results
- scrollUntilVisible:
    element:
      text: "Results"
    direction: DOWN
    timeout: 5000

# Assert results are displayed
- assertVisible:
    text: "Analysis"
  regex: true

- assertVisible:
    text: "ROI"
    regex: true

- assertVisible:
    text: "Recommendations"
    regex: true

---
# Test 6: Download Task Report
- tapOn:
    text: "Download Report"
    label: "Download task report"

- waitFor:
    text: "Report downloaded"
    timeout: 15000

---
# Test 7: Create Follow-up Task
- tapOn:
    text: "Create Follow-up"
    label: "Create follow-up task"

- tapOn:
    id: "task-title-input"
    label: "Tap title for follow-up"

- inputText: "Implement Q1 Marketing Recommendations"

- tapOn:
    id: "task-description-input"
    label: "Tap description"

- inputText: "Execute the recommended marketing strategies from the Q4 analysis"

- tapOn:
    text: "Create Task"
    label: "Create follow-up task"

- waitFor:
    text: "Task created successfully"
    timeout: 15000

- tapOn:
    text: "OK"
    label: "Dismiss success"

---
# Test 8: Test Task with DevOps Agent
- tapOn:
    text: "Close"
    label: "Close task details"

- scrollUntilVisible:
    element:
      text: "System Performance"
    direction: DOWN
    timeout: 5000

- tapOn:
    text: "System Performance"
    label: "Open DevOps task"

- tapOn:
    text: "Start Task"
    label: "Start DevOps task"

# Wait for task to start
- waitFor:
    text: "Running"
    timeout: 15000

---
# Test 9: Monitor DevOps Task
- scrollUntilVisible:
    element:
      text: "Progress"
    direction: DOWN
    timeout: 5000

# Assert DevOps-specific messages
- assertVisible:
    text: "Scanning system"
    regex: true

- waitFor:
    text: "Identifying bottlenecks"
    timeout: 30000

# Wait for completion
- waitFor:
    text: "Completed"
    timeout: 60000

---
# Test 10: Verify Task History
- tapOn:
    text: "Task History"
    label: "Open task history"

# Verify completed tasks
- assertVisible:
    text: "Q4 Marketing Campaign"

- assertVisible:
    text: "System Performance"

- assertVisible:
    text: "Completed"
    regex: true

# Assert timestamps
- assertVisible:
    text: "Completed on"
    regex: true

---
# Test 11: Test Task Retry on Failure
# This simulates a failed task
- tapOn:
    text: "Close"
    label: "Close history"

- tapOn:
    testID: "fab-create-task"
    label: "Create test task"

- inputText: "Test Task for Retry"
    label: "Enter test title"

- tapOn:
    text: "Create Task"
    label: "Create test task"

- tapOn:
    text: "OK"
    label: "Dismiss success"

- tapOn:
    text: "Test Task for Retry"
    label: "Open test task"

# Simulate task failure
- tapOn:
    text: "Simulate Failure"
    label: "Simulate task failure"

- waitFor:
    text: "Failed"
    timeout: 10000

# Assert retry button
- assertVisible:
    text: "Retry Task"

# Test retry functionality
- tapOn:
    text: "Retry Task"
    label: "Retry failed task"

- waitFor:
    text: "Retrying..."
    timeout: 5000

- runFlow:
    file: ../../utils/helpers.yaml
    args:
      message: "Task Execution Test Completed Successfully"