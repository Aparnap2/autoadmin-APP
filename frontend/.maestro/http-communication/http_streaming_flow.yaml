appId: host.exp.Exponent
name: "HTTP Streaming & SSE Communication Flow"
tags:
  - critical
  - http-only
  - streaming
  - integration
env:
  HTTP_ONLY_MODE: "true"
  ENABLE_STREAMING: "true"
  STREAMING_TIMEOUT: "30000"
  API_BASE_URL: "http://localhost:8000/api/v1"
onFlowStart:
  - runScript: ../utils/setup_http_server.js
---
# Launch app and navigate to chat interface
- launchApp
- tapOn:
    text: "Chat"

# Verify chat interface loads with HTTP streaming
- assertVisible:
    id: "agent-chat-interface"
- extendedWaitUntil:
    visible: "Message CEO Agent"
    timeout: 10000

# Verify streaming indicators are visible
- assertVisible: "HTTP streaming enabled"
- assertVisible: "SSE fallback ready"

# Test HTTP streaming with simple message
- tapOn:
    id: "chat-input"
- inputText: "Hello, can you test HTTP streaming?"
- tapOn: "Send"

# Wait for streaming to start
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 5000

# Verify streaming content appears
- assertVisible:
    id: "message-list"

# Wait for streaming response (HTTP chunked transfer)
- extendedWaitUntil:
    visible: "CEO Agent"
    timeout: 15000

# Verify complete response received
- assertVisible: "response completed"
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 10000

# Test rapid message streaming
- repeat:
    times: 3
    commands:
      - tapOn:
          id: "chat-input"
      - inputText: "Quick test ${__INDEX__}"
      - tapOn: "Send"
      - extendedWaitUntil:
          visible: "Streaming"
          timeout: 3000
      - extendedWaitUntil:
          notVisible: "Streaming"
          timeout: 8000

# Verify all messages received via HTTP streaming
- assertVisible: "Quick test 0"
- assertVisible: "Quick test 1"
- assertVisible: "Quick test 2"

# Test streaming interruption and recovery
- tapOn:
    id: "chat-input"
- inputText: "Test streaming recovery after interruption"
- tapOn: "Send"

# Simulate network interruption (if possible)
- evalScript: ${console.log('⚠️ Simulating network interruption')}
- waitBetween: 2000

# Verify streaming recovers
- extendedWaitUntil:
    visible: "Streaming recovered"
    timeout: 10000
- assertVisible: "Reconnected via HTTP"

# Verify message list is maintained
- assertVisible: "Quick test 2"

# Test long streaming response
- tapOn:
    id: "chat-input"
- inputText: "Please provide a comprehensive system status update"
- tapOn: "Send"

# Wait for long streaming response
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 3000
- repeat:
    times: 10
    commands:
      - waitBetween: 1000
      - assertVisible:
          id: "message-list"

# Verify streaming completes
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 20000

# Log successful HTTP streaming test
- evalScript: ${console.log('✅ HTTP streaming test completed successfully')}

# Take final screenshot
- takeScreenshot: "http-streaming-test-complete"