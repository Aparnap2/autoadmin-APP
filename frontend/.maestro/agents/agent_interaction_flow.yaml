appId: host.exp.Exponent
name: "Agent Interaction Workflow (HTTP-Only)"
tags:
  - critical
  - http-only
  - agents
  - integration
env:
  HTTP_ONLY_MODE: "true"
  TEST_USER_ID: "test-user-autoadmin"
  API_BASE_URL: "http://localhost:8000/api/v1"
onFlowStart:
  - runScript: ../utils/setup_agent_mock.js
---
# Navigate to agent interface
- launchApp
- tapOn:
    text: "Chat"

# Verify agent chat interface loads
- assertVisible:
    id: "agent-chat-interface"
- extendedWaitUntil:
    visible: "Agent Selector"
    timeout: 8000

# Test CEO Agent interaction
- tapOn: "CEO"
- assertVisible: "Message CEO Agent"

# Send status request to CEO Agent
- tapOn:
    id: "chat-input"
- inputText: "Please provide a comprehensive system status update"
- tapOn: "Send"

# Wait for HTTP streaming response
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 5000
- extendedWaitUntil:
    visible: "CEO Agent"
    timeout: 15000

# Verify CEO Agent response
- assertVisible: "System Status"
- assertVisible: "Agent Operations"
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 10000

# Test Strategy Agent interaction
- tapOn: "Strategy"
- assertVisible: "Message STRATEGY Agent"

# Send market analysis request
- tapOn:
    id: "chat-input"
- inputText: "Analyze current market trends and provide strategic insights"
- tapOn: "Send"

# Wait for strategy agent response
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 5000
- extendedWaitUntil:
    visible: "STRATEGY Agent"
    timeout: 15000

# Verify strategy agent response
- assertVisible: "Market Analysis"
- assertVisible: "Strategic Insights"
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 10000

# Test DevOps Agent interaction
- tapOn: "DevOps"
- assertVisible: "Message DEVOPS Agent"

# Send system health request
- tapOn:
    id: "chat-input"
- inputText: "Check system health and identify optimization opportunities"
- tapOn: "Send"

# Wait for DevOps agent response
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 5000
- extendedWaitUntil:
    visible: "DEVOPS Agent"
    timeout: 15000

# Verify DevOps agent response
- assertVisible: "System Health"
- assertVisible: "Optimization"
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 10000

# Test agent switching in conversation
- tapOn: "CEO"
- tapOn:
    id: "chat-input"
- inputText: "Summarize the findings from Strategy and DevOps agents"
- tapOn: "Send"

# Wait for CEO synthesis response
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 5000
- extendedWaitUntil:
    visible: "Summary"
    timeout: 15000

# Test quick actions (HTTP-based)
- tapOn: "Status Update"
- extendedWaitUntil:
    visible: "Streaming"
    timeout: 3000
- extendedWaitUntil:
    notVisible: "Streaming"
    timeout: 8000

# Test concurrent agent requests
- tapOn: "Strategy"
- tapOn:
    id: "chat-input"
- inputText: "Quick market check"
- tapOn: "Send"

# Switch to CEO while strategy is responding
- waitBetween: 1000
- tapOn: "CEO"
- tapOn:
    id: "chat-input"
- inputText: "Quick status check"
- tapOn: "Send"

# Verify both agents respond
- extendedWaitUntil:
    visible: "Market"
    timeout: 10000
- extendedWaitUntil:
    visible: "Status"
    timeout: 10000

# Test agent error handling
- tapOn:
    id: "chat-input"
- inputText: "This should trigger an error handling test"
- tapOn: "Send"

# Verify error handling works gracefully
- assertNotVisible: "Agent crashed"
- assertVisible: "Error handled gracefully"

# Test agent reconnection via HTTP
- evalScript: ${console.log('ðŸ”„ Testing agent reconnection...')}
- waitBetween: 2000

- tapOn: "DevOps"
- tapOn:
    id: "chat-input"
- inputText: "Test reconnection after simulated disconnection"
- tapOn: "Send"

# Verify agent reconnection via HTTP
- extendedWaitUntil:
    visible: "Reconnected"
    timeout: 10000
- assertVisible: "HTTP connection restored"

# Log successful agent interaction test
- evalScript: ${console.log('âœ… Agent interaction test completed successfully')}

# Take final screenshot
- takeScreenshot: "agent-interaction-http-only-complete"