# Maestro Flow: HTTP Server-Sent Events (SSE) Connection Test
# Tests HTTP-only communication replacing WebSocket functionality

appId: host.exp.Exponent

# Test metadata
tags:
  - critical
  - http-communication
  - real-time
  - streaming

# Test setup
launchArgs:
  detoxDebug: false
  recordLogs: true

---
# 1. Launch app and verify HTTP-only mode
- launchApp
- assertVisible: "AutoAdmin"
- assertVisible:
    text: "HTTP Streaming"
    id: "streaming-status"

# 2. Initialize HTTP streaming client
- tapOn:
    id: "streaming-toggle"
- assertVisible: "Connecting via HTTP..."
- assertVisible:
    text: "Server-Sent Events"
    id: "connection-type"

# 3. Test SSE connection establishment
- waitFor:
    text: "Connected"
    id: "connection-status"
    timeout: 10000

# 4. Verify connection metrics
- assertVisible:
    text: "Active"
    id: "connection-state"
- assertVisible:
    text: "0ms"
    id: "connection-latency"

# 5. Test real-time event reception
- runFlow: "../agent-orchestration/trigger_agent_task.yaml"
- waitFor:
    text: "Agent status update"
    id: "event-log"
    timeout: 15000

# 6. Verify event parsing and display
- assertVisible: "Task completed"
- assertVisible:
    text: "marketing_agent"
    id: "event-source"

# 7. Test connection resilience (reconnection)
- tapOn:
    id: "disconnect-button"
- assertVisible: "Disconnected"
- tapOn:
    id: "reconnect-button"
- waitFor:
    text: "Connected"
    timeout: 10000

# 8. Test connection error handling
# Simulate network interruption
- tapOn:
    id: "simulate-error"
- assertVisible: "Connection error"
- assertVisible: "Attempting reconnection..."
- waitFor:
    text: "Connected"
    timeout: 15000

# 9. Test lazy loading (no continuous polling)
- assertNotVisible:
    text: "Polling"
    id: "connection-type"
- assertVisible:
    text: "Event-driven"
    id: "update-mode"

# 10. Performance validation
- assertVisible:
    text: "< 100ms"
    id: "last-event-latency"
- assertVisible:
    text: "0"
    id: "polling-count"  # Should remain 0