name: AutoAdmin Deep Agents Workflow

on:
  # Manual trigger for on-demand execution
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        default: 'proactive'
        type: choice
        options:
          - proactive
          - interactive
          - task
      message:
        description: 'Message for interactive mode'
        required: false
        type: string
      task_type:
        description: 'Task type for task mode'
        required: false
        type: choice
        options:
          - ceo
          - strategy
          - devops
      task_description:
        description: 'Task description for task mode'
        required: false
        type: string

  # Repository dispatch for triggering from external systems
  repository_dispatch:
    types: [start_task, run_proactive]

  # Schedule for daily proactive analysis
  schedule:
    - cron: "0 9 * * *"  # Run daily at 9 AM UTC

  # Push to main branch (for testing)
  push:
    branches: [main, develop]

  # Pull request for testing
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # Main agent execution job
  run-agents:
    name: Run AutoAdmin Agents
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Only run on schedule or manual trigger with proper secrets
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'repository_dispatch' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install uv for faster dependency management
        run: |
          pip install uv

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Log in to Docker Hub (optional)
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t autoadmin-agents:${{ github.sha }} .
          docker tag autoadmin-agents:${{ github.sha }} autoadmin-agents:latest

      - name: Run tests before execution
        run: |
          uv run pytest tests/ -v --tb=short

      - name: Execute AutoAdmin Agents
        env:
          # OpenAI Configuration
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # Supabase Configuration
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

          # GitHub Configuration
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}

          # Tavily Configuration
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

          # Execution Configuration
          LOG_LEVEL: INFO
          ENVIRONMENT: production
          SESSION_ID: gh-${{ github.run_id }}-${{ github.run_attempt }}

        run: |
          # Determine execution mode
          MODE="${{ github.event.inputs.mode || 'proactive' }}"

          case "$MODE" in
            "interactive")
              MESSAGE="${{ github.event.inputs.message || 'Run your daily proactive analysis' }}"
              echo "Running in interactive mode with message: $MESSAGE"
              docker run --rm \
                -e OPENAI_API_KEY -e SUPABASE_URL -e SUPABASE_KEY \
                -e GITHUB_TOKEN -e GITHUB_REPO -e TAVILY_API_KEY \
                -e LOG_LEVEL -e ENVIRONMENT -e SESSION_ID \
                autoadmin-agents:latest \
                --mode interactive --message "$MESSAGE"
              ;;
            "task")
              TASK_TYPE="${{ github.event.inputs.task_type || 'strategy' }}"
              TASK_DESC="${{ github.event.inputs.task_description || 'Perform routine analysis' }}"
              echo "Running in task mode: $TASK_TYPE - $TASK_DESC"
              docker run --rm \
                -e OPENAI_API_KEY -e SUPABASE_URL -e SUPABASE_KEY \
                -e GITHUB_TOKEN -e GITHUB_REPO -e TAVILY_API_KEY \
                -e LOG_LEVEL -e ENVIRONMENT -e SESSION_ID \
                autoadmin-agents:latest \
                --mode task --task-type "$TASK_TYPE" --task-description "$TASK_DESC"
              ;;
            *)
              echo "Running in proactive mode"
              docker run --rm \
                -e OPENAI_API_KEY -e SUPABASE_URL -e SUPABASE_KEY \
                -e GITHUB_TOKEN -e GITHUB_REPO -e TAVILY_API_KEY \
                -e LOG_LEVEL -e ENVIRONMENT -e SESSION_ID \
                autoadmin-agents:latest \
                --mode proactive
              ;;
          esac

      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-execution-logs-${{ github.run_id }}
          path: |
            logs/
            *.log
          retention-days: 7

      - name: Push Docker image (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          docker push autoadmin-agents:${{ github.sha }}
          docker push autoadmin-agents:latest

  # Security scan job
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'autoadmin-agents:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Performance test job
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'proactive'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install uv
          uv sync --frozen

      - name: Run performance tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          uv run python -m pytest tests/performance/ -v --tb=short

  # Notification job
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [run-agents]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Send success notification
        if: needs.run-agents.result == 'success'
        run: |
          echo "✅ AutoAdmin agents executed successfully"
          # Add Slack/Teams notification logic here if needed

      - name: Send failure notification
        if: needs.run-agents.result == 'failure'
        run: |
          echo "❌ AutoAdmin agents execution failed"
          # Add Slack/Teams notification logic here if needed

  # Cleanup job
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [run-agents]
    if: always()

    steps:
      - name: Clean up Docker resources
        run: |
          docker system prune -f
          docker volume prune -f